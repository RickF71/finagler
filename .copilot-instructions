# Copilot Investigation: Endpoint Format Mapping + Refactor Preparation

Objective:
Map every existing API endpoint, its supported output formats, and the structure of its responses across the DIS-Core backend.
The goal is to prepare for a unified refactor where each endpoint supports /{format} suffixes (json, file, cbor, encrypted) and consistent JSON error handling for unsupported types.

Mission:
1. Crawl all Go files under /internal/api and /routes for:
   - Route registration lines (mux.HandleFunc, chi.Route, chi.Get/Post/Put, etc.)
   - Functions prefixed with handle*
   - Any switch or if/else that sets Content-Type headers
   - Any use of w.Write([]byte(...)), w.Header().Set("Content-Type", ...)
   - Any direct writes of text/css, text/plain, application/json, or other MIME types.

2. For each discovered handler:
   - Report: File, function name, line numbers, registered route pattern.
   - List which formats it currently supports (json, file, text/css, etc.).
   - Identify whether it currently uses the standard JSON response helper (`JSON`, `JSONError`) or manual writes.
   - Flag any that return non-JSON errors (e.g., `http.Error`, raw text, fmt.Fprintf).

3. For handlers that serve or consume files (CSS, policy, schema, etc.):
   - Note if they use a fixed MIME type or derive it dynamically.
   - Identify whether they should gain `/file` or `/json` suffix support.

4. For any handlers that already use content negotiation or file suffixes:
   - Document how it’s implemented (route param, header, etc.).
   - Suggest whether it can migrate easily to the new unified pattern.

5. Output a structured summary (Markdown table):
   - Columns: Route | Method | Handler | Current Formats | Uses JSON Helpers | Suggested Formats | File Path
   - Followed by a short narrative summary highlighting where refactor complexity lies.

Expected Output:
- A concise Markdown table summarizing all current endpoint formats and handler implementations.
- Identification of handlers that need changes to support the new /{format} suffix pattern.
- List of all endpoints not yet using JSONError or JSONUnsupportedFormat.
- Clear “refactor targets” list to guide Copilot or manual implementation next.

Follow-up Mission:
After mapping is complete, generate the refactor plan:
- Define standard format-switch skeleton for each handler (json/file/cbor/encrypted).
- Replace non-JSON error responses with JSONUnsupportedFormat.
- Add JSONError/JSON helpers to handlers that lack them.
